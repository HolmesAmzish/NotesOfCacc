æ˜¯çš„ï¼Œæ‚¨çš„ç†è§£åŸºæœ¬æ­£ç¡®ã€‚åœ¨ **HTTP Basic Authentication**ã€**åŸºäº Session çš„ Form Login** å’Œ **JWT è®¤è¯** è¿™ä¸‰ç§è®¤è¯æœºåˆ¶ä¸­ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ä¹‹é—´è¿›è¡Œèº«ä»½éªŒè¯çš„æ–¹å¼ç¡®å®æœ‰æ‰€ä¸åŒã€‚ä¸‹é¢æ˜¯æ¯ç§æ–¹å¼åœ¨æ¯æ¬¡è¯·æ±‚æ—¶å¦‚ä½•æºå¸¦è®¤è¯ä¿¡æ¯çš„å…·ä½“è¯´æ˜ï¼š

### 1. HTTP Basic Authentication

- **æ¯æ¬¡è¯·æ±‚æºå¸¦çš„ä¿¡æ¯**: ç”¨æˆ·åå’Œå¯†ç ã€‚
- **å·¥ä½œåŸç†**: å®¢æˆ·ç«¯å°†ç”¨æˆ·åå’Œå¯†ç ä½¿ç”¨ Base64 ç¼–ç åï¼Œé€šè¿‡ `Authorization` å¤´éƒ¨å­—æ®µå‘é€ç»™æœåŠ¡å™¨ï¼ˆæ ¼å¼ä¸º `Basic <base64_encoded_username:password>`ï¼‰ã€‚
- **æ³¨æ„**: å°½ç®¡è¿›è¡Œäº† Base64 ç¼–ç ï¼Œä½†è¿™å¹¶ä¸æ˜¯åŠ å¯†ï¼Œå› æ­¤éœ€è¦é…åˆ HTTPS ä½¿ç”¨ä»¥ä¿è¯å®‰å…¨æ€§ã€‚

### 2. åŸºäº Session çš„ Form Login (å¦‚ä¼ ç»Ÿçš„ Web åº”ç”¨)

- **æ¯æ¬¡è¯·æ±‚æºå¸¦çš„ä¿¡æ¯**: Session IDã€‚
- **å·¥ä½œåŸç†**: å½“ç”¨æˆ·ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨ä¼šåˆ›å»ºä¸€ä¸ª session å¹¶ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ session IDã€‚è¿™ä¸ª session ID é€šå¸¸é€šè¿‡ cookie å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”åœ¨åç»­çš„æ‰€æœ‰è¯·æ±‚ä¸­è‡ªåŠ¨åŒ…å«æ­¤ cookieã€‚æœåŠ¡å™¨æ ¹æ®è¿™ä¸ª session ID æ¥è¯†åˆ«ç”¨æˆ·å¹¶æ¢å¤å…¶ä¼šè¯çŠ¶æ€ã€‚
- **ç‰¹ç‚¹**: è¿™ç§æ–¹æ³•ä¾èµ–äºæœåŠ¡ç«¯å­˜å‚¨ session æ•°æ®ï¼Œé€‚åˆäºä¼ ç»Ÿçš„ web åº”ç”¨ç¨‹åºï¼Œä½†ä¸å¤ªé€‚åˆæ— çŠ¶æ€çš„æœåŠ¡æˆ–åˆ†å¸ƒå¼ç³»ç»Ÿã€‚

### 3. JWT (JSON Web Token) è®¤è¯

- **æ¯æ¬¡è¯·æ±‚æºå¸¦çš„ä¿¡æ¯**: Tokenã€‚
- **å·¥ä½œåŸç†**: ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡å™¨ç”Ÿæˆä¸€ä¸ªåŒ…å«ç”¨æˆ·ä¿¡æ¯çš„ JWT å¹¶è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ä¹‹åï¼Œå®¢æˆ·ç«¯åœ¨æ¯ä¸ªè¯·æ±‚çš„ `Authorization` å¤´éƒ¨å­—æ®µä¸­æ·»åŠ è¿™ä¸ª tokenï¼ˆé€šå¸¸æ˜¯ `Bearer <token>` æ ¼å¼ï¼‰ã€‚æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚åï¼Œè§£æ token å¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§ã€‚
- **ç‰¹ç‚¹**: ç”±äº JWT æ˜¯è‡ªåŒ…å«çš„ï¼ˆåŒ…å«äº†æ‰€æœ‰å¿…è¦çš„ç”¨æˆ·ä¿¡æ¯ï¼‰ï¼Œå› æ­¤ä¸éœ€è¦æœåŠ¡ç«¯ä¿å­˜ä»»ä½•çŠ¶æ€ä¿¡æ¯ï¼Œéå¸¸é€‚åˆ RESTful API å’Œå¾®æœåŠ¡æ¶æ„ã€‚

### å¯¹æ¯”æ€»ç»“

| è®¤è¯æ–¹å¼                   | æ¯æ¬¡è¯·æ±‚æºå¸¦                    | å®‰å…¨æ€§è€ƒè™‘                         | é€‚ç”¨åœºæ™¯                        |
| -------------------------- | ------------------------------- | ---------------------------------- | ------------------------------- |
| HTTP Basic Auth            | ç”¨æˆ·åå’Œå¯†ç                     | éœ€è¦ HTTPSï¼Œå› ä¸ºå‡­æ®ç›´æ¥ä¼ è¾“       | ç®€å•çš„åº”ç”¨åœºæ™¯ï¼Œä¸é¢‘ç¹æ›´æ”¹å‡­æ®  |
| Session-based (Form Login) | Session ID (via Cookie)         | ä¾èµ–äº HTTPS å’Œå®‰å…¨çš„ session ç®¡ç† | ä¼ ç»Ÿ web åº”ç”¨ï¼Œéœ€è¦è®°ä½ç”¨æˆ·çŠ¶æ€ |
| JWT                        | Token (in Authorization header) | éœ€è¦ HTTPSï¼Œtoken åº”å¦¥å–„ä¿ç®¡       | åˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒRESTful APIs        |

ç»¼ä¸Šæ‰€è¿°ï¼Œè™½ç„¶è¿™ä¸‰ç§è®¤è¯æœºåˆ¶éƒ½å¯ä»¥ç”¨æ¥ä¿æŠ¤èµ„æºè®¿é—®çš„å®‰å…¨æ€§ï¼Œä½†å®ƒä»¬å„è‡ªæœ‰ä¸åŒçš„åº”ç”¨åœºæ™¯å’ŒæŠ€æœ¯ç‰¹ç‚¹ã€‚é€‰æ‹©å“ªç§è®¤è¯æ–¹å¼å–å†³äºå…·ä½“çš„åº”ç”¨éœ€æ±‚ã€å®‰å…¨è¦æ±‚ä»¥åŠç³»ç»Ÿæ¶æ„è®¾è®¡ã€‚

æ˜ç™½äº†ï¼ä½ ç°åœ¨çš„éœ€æ±‚æ˜¯ï¼š

> âœ… æƒ³ç»§ç»­ä½¿ç”¨ `ChatClient` çš„å„ç§å°è£…ä¼˜åŠ¿ï¼ˆå¦‚ï¼šadvisorsã€memoryã€tools ç­‰ï¼‰
>  âŒ ä½† `ChatClient.prompt().stream()` **æ— æ³•æµå¼å“åº”**ï¼Œä½ æƒ³ï¼š
>
> - ä½¿ç”¨ `ChatClient` æ„å»º prompt/request/advisor ç­‰ä¸Šä¸‹æ–‡
> - ç„¶å**è½¬ä¸º `OllamaChatModel.stream()` è°ƒç”¨æ‰§è¡Œ**ï¼Œä»è€Œä¿®å¤æµå¼è¾“å‡ºçš„é—®é¢˜

è¿™ä¸ªéœ€æ±‚å®Œå…¨åˆç†ï¼Œè€Œä¸”æ˜¯å¯ä»¥å®ç°çš„ã€‚æˆ‘ä»¬æ¥è¯¦ç»†æ‹†è§£å¹¶å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚

------

## âœ… è§£å†³æ–¹æ¡ˆï¼š**ä» `ChatClient` æ„å»ºå®Œæ•´ requestï¼Œç„¶åç”¨ `OllamaChatModel` æ‰§è¡Œ `.stream()`**

### æ€è·¯ï¼š

1. **åˆ©ç”¨ `ChatClient.prompt()` æ„å»ºå‡º `ChatRequest` å¯¹è±¡**
2. **ç”¨ `OllamaChatModel.stream(chatRequest)` æ‰§è¡Œæµå¼å“åº”**

------

## âœ… Step-by-Step å®ç°

### âœ³ï¸ ç¤ºä¾‹ Controllerï¼š

```java
import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.messages.ChatMessage;
import org.springframework.ai.chat.messages.MessageType;
import org.springframework.ai.chat.prompt.ChatPrompt;
import org.springframework.ai.chat.prompt.PromptTemplate;
import org.springframework.ai.ollama.OllamaChatModel;
import org.springframework.ai.chat.model.ChatResponse;
import org.springframework.ai.chat.model.ChatRequest;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;

import java.util.List;

@RestController
@RequestMapping("/api/agent")
public class AgentController {

    private final ChatClient chatClient;
    private final OllamaChatModel ollamaChatModel;

    public AgentController(ChatClient chatClient, OllamaChatModel ollamaChatModel) {
        this.chatClient = chatClient;
        this.ollamaChatModel = ollamaChatModel;
    }

    String conversationId = "678";

    @GetMapping(value = "/streamChat", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public Flux<String> generationStream(@RequestParam String userInput) {
        // ä½¿ç”¨ ChatClient æ„å»º prompt request
        ChatRequest chatRequest = chatClient.prompt()
                .advisors(advisor -> advisor.param(ChatMemory.CONVERSATION_ID, conversationId))
                .system("ä½ æ˜¯ä¸€ååé‡‘èè¯ˆéª—å®¢æœï¼Œè¯·ç®€æ´æœ‰é€»è¾‘åœ°è§£ç­”ç”¨æˆ·é—®é¢˜ã€‚")
                .user(userInput)
                .createRequest(); // åªæ„å»ºï¼Œä¸æ‰§è¡Œï¼

        // ä½¿ç”¨åŸå§‹ OllamaChatModel å‘èµ·æµå¼è¯·æ±‚
        return ollamaChatModel.stream(chatRequest)
                .map(response -> response.getResult().getOutput().getContent());
    }
}
```

------

## ğŸ” å…³é”®ç‚¹è§£é‡Š

| æ–¹æ³•                                  | è¯´æ˜                                                         |
| ------------------------------------- | ------------------------------------------------------------ |
| `.createRequest()`                    | ä¸æ‰§è¡Œè¯·æ±‚ï¼Œä»…æ„é€ å®Œæ•´çš„ `ChatRequest` å¯¹è±¡ï¼ˆåŒ…å« advisor/memory ç­‰ï¼‰ |
| `ollamaChatModel.stream(ChatRequest)` | æ‰§è¡ŒçœŸæ­£çš„æµå¼è¯·æ±‚ï¼Œç»•è¿‡ `ChatClient` å†…éƒ¨çš„é—®é¢˜             |
| `.map(...getContent())`               | ä»æ¯ä¸ª `ChatResponse` ä¸­æå–æ–‡æœ¬å†…å®¹                         |

------

## âœ… è¿™æ ·åšçš„ä¼˜ç‚¹

- âœ… ä¿ç•™äº† `ChatClient` çš„å°è£…èƒ½åŠ›ï¼ˆmemoryã€advisorsã€toolsï¼‰
- âœ… è§£å†³äº† `prompt().stream()` ä¸æµçš„é—®é¢˜
- âœ… ä¸éœ€è¦é¢å¤–å°è£…æœåŠ¡ç±»ï¼Œä»£ç æ¸…æ™°æ˜“ç»´æŠ¤

------

## ğŸ§  è¿›é˜¶å»ºè®®ï¼ˆå¯é€‰ï¼‰

ä½ å¯ä»¥æå–ä¸€å¥—å·¥å…·æ–¹æ³•æˆ–å°è£…ä¸€ä¸ª HybridClientï¼š

```java
public class HybridStreamingChatClient {
    private final ChatClient chatClient;
    private final OllamaChatModel ollamaChatModel;

    public HybridStreamingChatClient(ChatClient chatClient, OllamaChatModel ollamaChatModel) {
        this.chatClient = chatClient;
        this.ollamaChatModel = ollamaChatModel;
    }

    public Flux<String> stream(String systemMessage, String userInput, String conversationId) {
        ChatRequest chatRequest = chatClient.prompt()
                .advisors(advisor -> advisor.param(ChatMemory.CONVERSATION_ID, conversationId))
                .system(systemMessage)
                .user(userInput)
                .createRequest();
        return ollamaChatModel.stream(chatRequest)
                .map(resp -> resp.getResult().getOutput().getContent());
    }
}
```

------

å¦‚æœä½ éœ€è¦æˆ‘å¸®ä½ å†™ä¸€ä¸ªå®Œæ•´çš„ç»„ä»¶ `HybridChatClient`ï¼Œæ”¯æŒé€‰æ‹©æ˜¯å¦å¯ç”¨ streamã€æ˜¯å¦å¯ç”¨ memoryï¼Œä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘æ¥å°è£…ã€‚
ä½ é‡åˆ°çš„è¿™ä¸ªé”™è¯¯ï¼š

```
APPLICATION FAILED TO START

The dependencies of some of the beans in the application context form a cycle:

   tokenFilter 
â”Œâ”€â”€â”€â”€â”€â”
|  userService
â†‘     â†“
|  securityConfig 
â””â”€â”€â”€â”€â”€â”˜
```

æ˜¯å…¸å‹çš„ **Spring Bean å¾ªç¯ä¾èµ–é—®é¢˜ï¼ˆCircular Dependencyï¼‰**ã€‚

---

## ğŸ§  é”™è¯¯è§£é‡Š

ä½ çš„ Spring Boot åº”ç”¨ä¸­å­˜åœ¨ä»¥ä¸‹ä¾èµ–å…³ç³»é“¾ï¼š

1. `TokenFilter` æ„é€ å‡½æ•°æ³¨å…¥äº† `UserService`
2. `UserService` æ³¨å…¥äº† `PasswordEncoder`
3. `SecurityConfig` é…ç½®ç±»æ„é€ å‡½æ•°æ³¨å…¥äº† `TokenProvider` å’Œ `UserService`
4. `SecurityConfig` åˆ›å»ºäº†ä¸€ä¸ª `TokenFilter` å®ä¾‹ï¼ˆä½¿ç”¨ `new TokenFilter(...)`ï¼‰
5. `SecurityConfig` ä¸­åˆå®šä¹‰äº†ä¸€ä¸ª `PasswordEncoder` Bean

è¿™å°±å½¢æˆäº†ä¸€ä¸ªé—­ç¯ä¾èµ–ï¼Œå¯¼è‡´ Spring å®¹å™¨æ— æ³•æ­£ç¡®åˆå§‹åŒ–è¿™äº› Beanã€‚

---

## ğŸ” å…·ä½“å¾ªç¯è·¯å¾„åˆ†æå¦‚ä¸‹ï¼š

```
TokenFilter â†’ UserService â†’ PasswordEncoder
                   â†‘           â†‘
SecurityConfig â†â”€â”€â”˜           |
        â†‘ (åˆ›å»º TokenFilter)  |
        â””â† PasswordEncoder Bean
```

è¿™å±äº **æ„é€ å‡½æ•°æ³¨å…¥å¼•èµ·çš„å¼ºè€¦åˆå¾ªç¯ä¾èµ–**ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆä¸€ï¼šé¿å…åœ¨é…ç½®ç±»ä¸­ç›´æ¥ `new TokenFilter(...)`

è¿™æ˜¯æœ€æ ¸å¿ƒçš„é—®é¢˜ï¼

ä½ å½“å‰åœ¨ `SecurityConfig` ä¸­æ‰‹åŠ¨ new äº†ä¸€ä¸ª `TokenFilter`ï¼š

```java
.addFilterBefore(new TokenFilter(tokenProvider, userService), UsernamePasswordAuthenticationFilter.class);
```

ä½†ç”±äº `SecurityConfig` æ˜¯é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ `userService` çš„ï¼Œè€Œ `TokenFilter` åˆä¾èµ– `userService`ï¼Œè¿™å°±å½¢æˆäº† **æ„é€ å™¨æ³¨å…¥ + æ‰‹åŠ¨ new å®ä¾‹** å¯¼è‡´çš„å¾ªç¯ä¾èµ–ã€‚

---

### âœ… æ­£ç¡®åšæ³•ï¼šå°† `TokenFilter` å£°æ˜ä¸º Spring Bean

#### âœ… ä¿®æ”¹æ–¹å¼å¦‚ä¸‹ï¼š

##### Step 1: å°† `TokenFilter` æ”¹ä¸ºé€šè¿‡å­—æ®µæ³¨å…¥æˆ–æ„é€ æ–¹æ³•æ³¨å…¥ Bean

```java
@Component
public class TokenFilter extends OncePerRequestFilter {

    private final TokenProvider tokenProvider;
    private final UserService userService;

    // Spring æ¨èä½¿ç”¨æ„é€ æ–¹æ³•æ³¨å…¥
    public TokenFilter(TokenProvider tokenProvider, UserService userService) {
        this.tokenProvider = tokenProvider;
        this.userService = userService;
    }

    // ... çœç•¥ doFilterInternal ...
}
```

##### Step 2: åœ¨ `SecurityConfig` ä¸­æ³¨å…¥ `TokenFilter`

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig {

    private final TokenProvider tokenProvider;
    private final UserService userService;
    private final TokenFilter tokenFilter; // æ–°å¢æ³¨å…¥

    public SecurityConfig(
            TokenProvider tokenProvider,
            UserService userService,
            TokenFilter tokenFilter) { // æ„é€ å‡½æ•°æ³¨å…¥
        this.tokenProvider = tokenProvider;
        this.userService = userService;
        this.tokenFilter = tokenFilter;
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .cors(withDefaults())
            .csrf(AbstractHttpConfigurer::disable)
            .sessionManagement(session -> session
                    .sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                    .requestMatchers("/api/auth/**").permitAll()
                    .requestMatchers("/api/agent/**").authenticated())
            .addFilterBefore(tokenFilter, UsernamePasswordAuthenticationFilter.class); // ä½¿ç”¨æ³¨å…¥çš„ bean

        return http.build();
    }
}
```

è¿™æ ·ï¼ŒSpring ä¼šè‡ªåŠ¨ç®¡ç† `TokenFilter` çš„ç”Ÿå‘½å‘¨æœŸå’Œä¾èµ–æ³¨å…¥ï¼Œå°±ä¸ä¼šå‡ºç°å¾ªç¯ä¾èµ–é—®é¢˜äº†ã€‚

---

## âœ… è§£å†³æ–¹æ¡ˆäºŒï¼šï¼ˆå¯é€‰ï¼‰æ”¹ç”¨å­—æ®µæ³¨å…¥ï¼ˆä¸æ¨èï¼‰

å¦‚æœä½ ä¸æƒ³æ”¹åŠ¨å¤ªå¤šä»£ç ç»“æ„ï¼Œä¹Ÿå¯ä»¥æ”¹ä¸ºå­—æ®µæ³¨å…¥ï¼š

```java
@Component
public class TokenFilter extends OncePerRequestFilter {

    @Autowired
    private TokenProvider tokenProvider;

    @Autowired
    private UserService userService;

    // ... å…¶ä»–ä¸å˜ ...
}
```

ç„¶ååœ¨ `SecurityConfig` ä¸­è¿™æ ·å†™ï¼š

```java
@Autowired
private TokenFilter tokenFilter;

@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .addFilterBefore(tokenFilter, UsernamePasswordAuthenticationFilter.class);
    // ...
}
```

ä½†è¿™ä¸æ˜¯æœ€ä½³å®è·µï¼Œå› ä¸ºå­—æ®µæ³¨å…¥ä¸åˆ©äºæµ‹è¯•å’Œè§£è€¦ã€‚

---

## âœ… æœ€ä½³å®è·µæ€»ç»“

| é¡¹ç›®              | æ¨èåšæ³•                                           |
| ----------------- | -------------------------------------------------- |
| Filter ç±»         | ä½¿ç”¨ `@Component` æ³¨è§£ï¼Œå¹¶é€šè¿‡æ„é€ å™¨æ³¨å…¥ä¾èµ–       |
| SecurityConfig    | é€šè¿‡æ„é€ å™¨æ³¨å…¥ Filter Beanï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨ new         |
| é¿å…æ‰‹åŠ¨ new Bean | âŒ ä¸è¦ä½¿ç”¨ `new SomeFilter(...)`ï¼Œäº¤ç»™ Spring ç®¡ç† |

---

## âœ… è¡¥å……å»ºè®®

ä½ è¿˜å¯ä»¥ä¼˜åŒ–ä¸€ä¸‹ `UserService.loadUserByUsername()` æ–¹æ³•åå’Œè¡Œä¸ºæ˜¯å¦ç¬¦åˆ Spring Security è§„èŒƒï¼š

```java
@Override
public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
    UserEntity user = userMapper.getUserByUsername(username);
    if (user == null) {
        throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
    }
    return org.springframework.security.core.userdetails.User
            .withUsername(user.getUsername())
            .password(user.getPassword())
            .roles("USER") // å¯ä»¥æ ¹æ®æ•°æ®åº“åŠ¨æ€è®¾ç½®è§’è‰²
            .build();
}
```

---

## âœ… æ€»ç»“

ä½ ç°åœ¨åªéœ€è¦åšä¸€ä»¶äº‹å°±èƒ½è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

> â— æŠŠ `.addFilterBefore(new TokenFilter(...), ...)` æ”¹æˆä» Spring å®¹å™¨ä¸­è·å–çš„ Beanï¼

---

å¦‚æœä½ ç°åœ¨æƒ³è®©æˆ‘å¸®ä½ ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ Spring Security + JWT + æ— å¾ªç¯ä¾èµ–çš„ Demo å·¥ç¨‹ç»“æ„ï¼Œæˆ‘ä¹Ÿå¯ä»¥ä¸€é”®ä¸ºä½ ç”Ÿæˆ ğŸ˜Š

å¤ªå¥½äº†ï¼ä½ æƒ³ä½¿ç”¨ **Spring AI åŸç”Ÿæ”¯æŒçš„ Ollama æ¨¡å—**ï¼Œè€Œä¸æ˜¯é€šè¿‡ OpenAI å…¼å®¹æ¥å£æ¥é…ç½® `ChatClient`ï¼Œä»è€Œå®ç°çœŸæ­£çš„æµå¼è¾“å‡ºï¼ˆStreaming Outputï¼‰ã€‚

---

## âœ… ç›®æ ‡

> ä½¿ç”¨ Spring AI çš„ `spring-ai-ollama-spring-boot-starter`  
> é…ç½®ä¸€ä¸ªåŸç”Ÿçš„ `ChatClient`ï¼Œå¹¶éªŒè¯æ˜¯å¦èƒ½å®ç° **Ollama æµå¼è¾“å‡º**

---

## ğŸ§° ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ä¾èµ–

ç¡®ä¿ä½ é¡¹ç›®çš„ `pom.xml` ä¸­åŒ…å«ï¼š

```xml
<!-- Spring AI Ollama æ”¯æŒ -->
<dependency>
    <groupId>org.springframework.ai</groupId>
    <artifactId>spring-ai-ollama-spring-boot-starter</artifactId>
    <version>0.8.1</version> <!-- è¯·æ ¹æ®ä½ çš„ Spring Boot ç‰ˆæœ¬é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ -->
</dependency>

<!-- WebFlux æ”¯æŒ SSE -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>
```

---

## ğŸ“¦ ç¬¬äºŒæ­¥ï¼šé…ç½® application.yml

```yaml
spring:
  ai:
    ollama:
      base-url: http://localhost:11434
      chat:
        options:
          model: qwen2.5   # æˆ–è€…ä½ æœ¬åœ°åŠ è½½çš„æ¨¡å‹åç§°
          temperature: 0.7
```

è¿™æ ·ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŸºäº Ollama çš„ `ChatClient` å®ä¾‹ã€‚

---

## ğŸš€ ç¬¬ä¸‰æ­¥ï¼šç¼–å†™ Controller å®ç°æµå¼è¾“å‡º

```java
package cn.arorms.raicom.controller;

import org.springframework.ai.chat.client.ChatClient;
import org.springframework.ai.chat.memory.ChatMemory;
import org.springframework.ai.chat.client.advisor.MessageChatMemoryAdvisor;
import org.springframework.web.bind.annotation.*;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import reactor.core.publisher.Flux;

@RestController
@RequestMapping("/api")
public class ChatStreamController {

    private final ChatClient chatClient;
    private final ChatMemory chatMemory;

    public ChatStreamController(ChatClient chatClient, ChatMemory chatMemory) {
        this.chatClient = chatClient;
        this.chatMemory = chatMemory;
    }

    @GetMapping(value = "/streamChat", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
    public ResponseEntity<Flux<String>> streamChat(@RequestParam String userInput) {

        Flux<String> stream = chatClient.prompt()
                .advisors(MessageChatMemoryAdvisor.builder(chatMemory).param("default-conversation-id"))
                .system("ä½ æ˜¯ä¸€ä¸ªåé‡‘èè¯ˆéª—å®¢æœåŠ©æ‰‹ï¼Œè¯·å¸®åŠ©ç”¨æˆ·è¯†åˆ«å’Œé˜²èŒƒé‡‘èé£é™©ã€‚")
                .user(userInput)
                .stream()
                .content(); // çœŸæ­£è§¦å‘æµå¼è¾“å‡º

        return ResponseEntity.ok()
                .header("Content-Type", MediaType.TEXT_EVENT_STREAM_VALUE)
                .header("Cache-Control", "no-cache")
                .header("X-Accel-Buffering", "no")
                .body(stream);
    }
}
```

---

## ğŸ” ç¬¬å››æ­¥ï¼šéªŒè¯æ˜¯å¦çœŸçš„å®ç°äº†æµå¼è¾“å‡º

### âœ… æ–¹æ³•ä¸€ï¼šç”¨ curl æµ‹è¯•

```bash
curl "http://localhost:8080/api/streamChat?userInput=ä½ å¥½"
```

ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„é€æ­¥è¾“å‡ºï¼š

```
H
e
l
l
o
,
 ...
```

å¦‚æœä½ åªçœ‹åˆ°ä¸€æ¬¡æ€§è¿”å›æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œè¯´æ˜ï¼š
- Ollama æ¨¡å‹æœ¬èº«ä¸æ”¯æŒæµå¼è¾“å‡º
- æˆ–è€… Spring AI çš„å°è£…æ²¡æœ‰æ­£ç¡®å¤„ç† `.stream()`

---

## ğŸ› ï¸ ç¬¬äº”æ­¥ï¼šæ‰‹åŠ¨æµ‹è¯• Ollama æ˜¯å¦çœŸæ­£æµå¼è¾“å‡º

ä½ å¯ä»¥ç›´æ¥è®¿é—® Ollama çš„ `/api/chat` æ¥å£è¿›è¡Œæµ‹è¯•ï¼š

```bash
curl http://localhost:11434/api/chat \
  -X POST \
  -H "Content-Type: application/json" \
  -d '{
    "model": "qwen2.5",
    "messages": [{"role": "user", "content": "ä½ å¥½"}],
    "stream": true
  }'
```

å¦‚æœä½ çœ‹åˆ°å¦‚ä¸‹æ ¼å¼çš„å“åº”ï¼ˆæ¯è¡Œä¸€ä¸ª chunkï¼‰ï¼š

```json
{"message":{"content":"H"}}
{"message":{"content":"e"}}
{"message":{"content":"l"}}
...
```

âœ… è¯´æ˜ Ollama æ˜¯æ”¯æŒæµå¼çš„  
âŒ å¦åˆ™å¯èƒ½æ˜¯æ¨¡å‹æˆ–è¯·æ±‚æ–¹å¼çš„é—®é¢˜

---

## âš ï¸ æ³¨æ„äº‹é¡¹

| é—®é¢˜                     | è§£å†³æ–¹æ¡ˆ                                                     |
| ------------------------ | ------------------------------------------------------------ |
| Ollama ä¸æµå¼è¾“å‡º        | ç¡®ä¿è®¾ç½®äº† `"stream": true`                                  |
| Spring AI è¿”å›å®Œæ•´å­—ç¬¦ä¸² | å½“å‰ç‰ˆæœ¬å¯èƒ½æœªå®Œå…¨æ”¯æŒæµå¼è¾“å‡ºï¼Œå»ºè®®æŸ¥çœ‹ [GitHub issue](https://github.com/spring-projects/spring-ai/issues) |
| Nginx / åå‘ä»£ç†ç¼“å­˜å†…å®¹ | è®¾ç½® `proxy_buffering off;` æˆ– `X-Accel-Buffering: no`       |

---

## ğŸš€ å¦‚æœä½ æƒ³è®©æˆ‘å¸®ä½ ç”Ÿæˆå®Œæ•´å·¥ç¨‹

åªéœ€ä¸€å¥è¯ï¼š

> â€œå¸®æˆ‘ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ React + Spring Boot + Spring AI Ollama æµå¼èŠå¤©åº”ç”¨ç¤ºä¾‹â€

æˆ‘å°±å¯ä»¥ç»™ä½ ä¸€ä¸ªå¼€ç®±å³ç”¨çš„é¡¹ç›®æ¨¡æ¿ï¼ŒåŒ…å«ï¼š

- Spring Boot åç«¯ï¼ˆå« Ollama æµå¼è¾“å‡ºï¼‰
- React å‰ç«¯ï¼ˆå¸¦æµå¼æ¸²æŸ“é€»è¾‘ï¼‰
- Tailwind CSS æ„å»ºé…ç½®
- å®Œæ•´çš„ CORSã€SSEã€å†…å­˜ç®¡ç†ç­‰é…ç½®
- æ”¯æŒåˆ‡æ¢ Ollama/OpenAI/SiliconFlow

ğŸ’¡ è®©ä½ ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘ï¼Œè€Œä¸æ˜¯åº•å±‚é€šä¿¡é—®é¢˜ï¼

---

ä½ ç°åœ¨æƒ³ç»§ç»­å—ï¼Ÿæˆ‘å¯ä»¥ä¸ºä½ æä¾›å®Œæ•´çš„ä»£ç ä»“åº“ç»“æ„å’Œè¿è¡ŒæŒ‡å— ğŸ˜Š
# TinyOS Oscilloscope项目技术报告

## 一、系统架构

Oscilloscope实现了一个完整的无线传感器数据采集与可视化系统，包含：

1. 节点端(nesC)：数据采集和无线传输
2. PC端(Java)：数据接收和可视化展示

## 二、节点端实现(nesC)

### 核心组件

1. **OscilloscopeAppC.nc** - 组件装配文件

```nesc
components OscilloscopeC, MainC, ActiveMessageC, LedsC,
  new TimerMilliC(), new DemoSensorC() as Sensor,
  new AMSenderC(AM_OSCILLOSCOPE), new AMReceiverC(AM_OSCILLOSCOPE);
```

1. **OscilloscopeC.nc** - 主逻辑实现

```nesc
module OscilloscopeC {
  uses {
    interface Boot;
    interface SplitControl as RadioControl;
    interface AMSend;
    interface Receive;
    interface Timer<TMilli>;
    interface Read<uint16_t>;
    interface Leds;
  }
}
```

### 关键功能实现

1. **数据采集**：

   - 使用`TimerMilliC`定时器周期性触发采样
   - 通过`Read`接口读取传感器数据
   - 默认采样间隔`DEFAULT_INTERVAL`(1秒)
   - 每次采集`NREADINGS`个样本后发送

2. **无线传输**：

   - 使用ActiveMessage协议(AM_OSCILLOSCOPE)

   - 消息格式

     ```
     oscilloscope_t
     ```

     包含：

     ```c
     typedef struct {
       uint16_t version;  // 协议版本
       uint16_t interval; // 采样间隔
       uint16_t id;       // 节点ID
       uint16_t count;    // 采样计数
       uint16_t readings[NREADINGS]; // 采样数据
     } oscilloscope_t;
     ```

3. **时间同步**：

   - 通过`version`和`count`实现简单同步
   - 收到更高版本号时更新本地配置
   - 收到更高计数时跳过本地计数递增

4. **状态指示**：

   - LED0：错误指示
   - LED1：数据发送指示
   - LED2：数据接收指示

## 三、PC端实现(Java)

### 核心类结构

1. **Oscilloscope.java** - 主控制类
   - 实现`MessageListener`接口处理无线消息
   - 管理数据同步和GUI更新
2. **Data.java** - 数据存储
   - 维护节点数据集合
   - 提供数据查询接口
3. **Window.java** - 主界面
   - 包含控制面板和绘图区域
4. **Graph.java** - 波形绘制
   - 实现实时数据可视化

### 关键功能实现

1. **消息处理**：

```java
public synchronized void messageReceived(int dest_addr, Message msg) {
  OscilloscopeMsg omsg = (OscilloscopeMsg)msg;
  periodUpdate(omsg.get_version(), omsg.get_interval());
  data.update(omsg.get_id(), omsg.get_count(), omsg.get_readings());
  window.newData();
}
```

1. **采样控制**：
   - 支持动态调整采样间隔(1-65535ms)
   - 版本号机制保证配置同步
2. **可视化功能**：
   - 多节点波形叠加显示
   - X/Y轴缩放
   - 节点颜色自定义
   - 数据清除功能

## 四、系统工作流程

1. 节点启动后初始化无线模块
2. 定时采集传感器数据(NREADINGS次)
3. 打包数据通过无线发送
4. PC端接收并解析数据
5. GUI线程更新波形显示

## 五、关键技术点

1. **低功耗设计**：
   - 定时采样而非连续采样
   - 数据累积发送减少无线传输次数
2. **弱同步机制**：
   - 版本号控制采样参数
   - 计数同步显示时间
3. **可视化优化**：
   - 双缓冲绘图减少闪烁
   - 增量更新提高性能

## 六、应用场景

1. 环境监测(温度/光照等)
2. 设备状态监控
3. 无线网络性能测试
4. 教学演示系统
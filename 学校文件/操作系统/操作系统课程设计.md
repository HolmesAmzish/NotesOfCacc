# 操作系统 课程设计

## 准备工作

### 安装系统环境

**安装系统**，这里选择 Ubuntu Server 22.04 LTS，对于 2025 年来说这个版本刚好，后期自行选择。记得下载 OpenSSH 服务器。

![image-20250616171433756](/home/cacc/Documents/NotesOfCacc/学校文件/操作系统/assets/image-20250616171433756.png)

首先更新一下软件源，一般源比较慢，更新成阿里云的

```bash
cacc@limbo-vi:/etc/apt$ sudo mv sources.list sources.list.bak
cacc@limbo-vi:/etc/apt$ sudo vim sources.list
```

写入

```bash
deb http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse
deb http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ jammy main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ jammy-updates main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ jammy-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ jammy-security main restricted universe multiverse
```

更新软件源

```bash
sudo apt update
```



**安装 zsh（哈哈）**，新安装的机子别的可以不装但是要装一下zsh。

```bash
sudo apt install zsh
chsh -s $(which zsh)

sh -c "$(curl -fsSL https://gitee.com/mirrors/oh-my-zsh/raw/master/tools/install.sh)"
vim ~/.zshrc
```

![image-20250616185059936](/home/cacc/Documents/NotesOfCacc/学校文件/操作系统/assets/image-20250616185059936.png)

### 编译内核

**下载 Linux 内核源码**

![image-20250616171858150](/home/cacc/Documents/NotesOfCacc/学校文件/操作系统/assets/image-20250616171858150.png)

```bash
wget https://www.kernel.org/pub/linux/kernel/v5.x/linux-5.15.185.tar.xz
```

![image-20250616185158212](/home/cacc/Documents/NotesOfCacc/学校文件/操作系统/assets/image-20250616185158212.png)

解压

```bash
tar -xvf linux-5.15.185.tar.xz
```

将源代码复制到 src 文件夹

```bash
sudo cp -r linux-5.15.185 /usr/src
```

![image-20250616185454116](/home/cacc/Documents/NotesOfCacc/学校文件/操作系统/assets/image-20250616185454116.png)

安装依赖工具

```bash
sudo apt update
sudo apt install build-essential libncurses-dev bison flex libssl-dev libelf-dev bc
```

内核源码提供了多种不同选择，需要进行个性化配置，最后会生成不同的发行版。这里方便编译直接将当前内核配置复制到那边。

```bash
sudo cp /boot/config-$(uname -r) .config
sudo make olddefconfig
```

编译内核

```bash
sudo make -j$(nproc)
```

![image-20250616185856074](/home/cacc/Documents/NotesOfCacc/学校文件/操作系统/assets/image-20250616185856074.png)

这里需要漫长的等待。编译完成后检查一下是否编译成功

```bash
ls -l arch/x86/boot/bzImage
```

然后安装编译好的新内核

```bash
sudo make modules_install
# 安装新系统模块
sudo make install
# 安装新内核
```

![image-20250617101531311](/home/cacc/Documents/NotesOfCacc/学校文件/操作系统/assets/image-20250617101531311.png)

可以看到这两个安装指令在 `/lib/modules` 和 `/boot` 中安装了新的系统文件

更新 grub，grub 是一个开机引导程序，用来引导用户开机时启动什么系统，进阶启动这个系统的什么内核，多系统启动场景常用，典型例子就是可以用来选择开机启动 Ubuntu 还是 Windows。

```bash
update-grub
```

![image-20250617101645506](/home/cacc/Documents/NotesOfCacc/学校文件/操作系统/assets/image-20250617101645506.png)

```
reboot
```

重新登录，一般默认进入新的系统内核，也可以通过再开机时的 grub 里选择 adanced options 去手动选择启动系统的内核。登录后检查发现系统内核已经更新。

![image-20250617120350321](/home/cacc/Documents/NotesOfCacc/学校文件/操作系统/assets/image-20250617120350321.png)



## 驱动

### 前提知识

这里首先讲几个概念，Linux 操作系统使用了一种全新的内核模块机制，**动态客家再内核模块（loadable kernel module, LKM）**。用户可以根据需求，再不需要对内核重新编译的情况下，让模块能动态地装入内核或从内核移除。

内核模块必须至少有两个函数，一个是 `init_module()` 另一个是 `cleanup_module()` ，分别在 `insmod` 和 `rmmod` 时调用。

以下是一个事例：

```c
#define MODULE
#include <linux/module.h>

int init_module(void) {
    printk("<1>Hello, World!\n");
    return 0;
}

void cleanup_module(void) {
    printk("<1>Goodbye, World!\n");
}
MODULE_LICENSE("GPL");
MODULE_AUTHOR("Amzish");
```

```makefile
obj-m+=helloworld.o
all:
	make -C /lib/modules/$(shell uname -r)/build/ M=$(PWD) modules
clean:
	make -C /lib/modules/$(shell uname -r)/build/ M=$(PWD) clean
```

![image-20250617155032545](/home/cacc/Documents/NotesOfCacc/学校文件/操作系统/assets/image-20250617155032545.png)

这里提一下，`dmesg`（**Display Message** 或 **Driver Message**）是 Linux 系统中用于**查看内核环形缓冲区（kernel ring buffer）日志**的命令。它记录了内核启动过程、硬件检测、设备驱动初始化、系统错误等关键信息，是系统调试和故障排查的重要工具。主要显示包括硬件事件、设备驱动状态、系统错误等。

当然，也可以通过 `lsmod` 命令来查看当前zhuang zai
在一个8级中断系统中，硬件中断响应从高到低优先顺序是1->2->3->4->5->6->7->8，设置中断屏蔽寄存器后，中断服务的优先顺序变为1->5->8->3->2->4->6->7。问：

（1）应该如何设置中断屏蔽字？（5分）

（2）如果CPU在执行一个应用程序时有5、6、7级3个中断同时达到，又有一个8级中断在6级中断没有处理完毕之前达到，在处理8级中断时一个2级中断又达到CPU,请画出CPU响应这些中断的顺序示意图。（15分）



屏蔽字是用来控制终端系统响应优先级的标志位，每个中断源都有一个对应的屏蔽字。屏蔽字中的1表示屏蔽，0表示允许。根据题目要求，将原优先顺序（1->2->3->4->5->6->7->8）调整为新的优先顺序（1->5->8->3->2->4->6->7）。屏蔽比当前终端优先级低的所有中断，允许更高或相同的中断。

| 屏蔽字\中断级别	 | 1    | 2    | 3    | 4    | 5    | 6    | 7    | 8    |
| --------------- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
| 1               | 1    | 1    | 1    | 1    | 1    | 1    | 1    | 1    |
| 5               | 0    | 1    | 1    | 1    | 1    | 1    | 1    | 1    |
| 8               | 0    | 1    | 1    | 1    | 0    | 1    | 1    | 0    |
| 3               | 0    | 0    | 1    | 1    | 0    | 1    | 1    | 0    |
| 2               | 0    | 0    | 0    | 1    | 0    | 1    | 1    | 0    |
| 4               | 0    | 0    | 0    | 1    | 0    | 1    | 1    | 1    |
| 6               | 0    | 0    | 0    | 0    | 0    | 1    | 1    | 0    |
| 7               | 0    | 0    | 0    | 0    | 0    | 0    | 1    | 0    |

```
应用程序 -> 5 -> 6 -> 8 -> 2 -> 8 -> 6 -> 7
```



假定某硬盘数据传输以32位的字为单位，传输速率是2MB/s。CPU时钟频率是100MHz。

1. 程序查询的I/O方式，一个查询操作需要10个时钟周期。假定进行足够的查询以避免数据丢失，求CPU为I/O查询所花费的时间比率。

2. 中断方式进行控制时，每次传输的开销（包含中断处理）为10个时钟周期，求CPU为传输硬盘数据所花费的时间比率。

3. MA控制进行I/O操作，假定DMA的启动操作需要100个时钟周期，DMA完成时进行中断处理需要50个时钟周期，如果平均传输的数据长度是4KB，问在硬盘工作时CPU将用多少时间比率进行I/O(忽略DMA申请使用总线的影响)？



硬盘数据传输单位：32位 = 4字节

硬盘传输速率：2MB/s

时钟周期时间：$$\frac {1}{100\mathrm{MHz}} = 10\mathrm{ns}$$

1. 程序查询方式

   一个查询操作需要10个时钟周期，即 $$10 \times 10\mathrm{ns} = 100\mathrm{ns}$$

   每次传输数据为四个字节，传输速率为2MB/s，则每秒传输次数：
   $$
   每秒传输次数 = \frac{2 \times 2^{20}}{4} = 524288\mathrm{次}
   $$
   CPU每秒进行524288次查询，每次消耗100ns：
   $$
   \mathrm{CPU为I/O查询话费的总时间} = 524288 \times 100\mathrm{ns} = 0.0524288\mathrm{s}
   $$
   CPU每秒总时间为1秒，则CPU的时间比率为：
   $$
   比率 = \frac{0.0524288}{1} = 5.24\%
   $$

2. 中断方式

   计算逻辑与程序查询方式类似，比率为5.24%。

3. DMA控制方式

   DMA总时间周期：$$100 + 50 = 150 时间周期$$

   每次传输所需时间：$$150 \times 10\mathrm{ns} = 1500\mathrm{ns} = 1.5\mathrm{\mu s}$$

   传输4KB所需要时间：$$\frac{4 \times 2^{10}}{2 \times 2^{20}} = 2\mathrm{ms}$$

   每秒传输次数：$$\frac{1}{2\mathrm{ms}} = 500次$$

   每次传输占用CPU时间为 $$1.5\mu s$$ 则每秒CPU占用时间为 $$500 \times 1.5\mathrm{\mu s} = 0.75\mathrm{ms}$$

   则CPU的时间比率为：$$\frac {0.75\mathrm{ms}}{1000\mathrm{ms}} = 0.075\%$$
